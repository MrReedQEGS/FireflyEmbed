<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Python Turtle (Browser)</title>

  <!-- CodeMirror -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.css">
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/python/python.js"></script>

  <style>
    body { margin:0; height:100vh; display:flex; flex-direction:column; font-family:system-ui,sans-serif; }
    header { padding:8px 12px; border-bottom:1px solid #ddd; display:flex; gap:10px; align-items:center; }
    #status { color:#555; }
    #app { flex:1; display:flex; min-height:0; }
    #left, #right { flex:1; display:flex; flex-direction:column; min-height:0; }
    #left { border-right:1px solid #ddd; }

    .pane { padding:6px 10px; font-size:14px; border-bottom:1px solid #eee; }

    #editorWrap { flex:1; }
    .CodeMirror { height:100%; font-size:14px; }

    #stageWrap { flex:1; background:#111; position:relative; }
    canvas {
      position:absolute;
      left:10px; top:10px;
      width:calc(100% - 20px);
      height:calc(100% - 20px);
      border:1px solid #333;
    }

    #consoleWrap { height:200px; background:#0b0b0b; }
    #console {
      height:100%;
      padding:10px;
      color:#eaeaea;
      font-family:monospace;
      overflow:auto;
      white-space:pre-wrap;
    }
  </style>
</head>

<body>
<header>
  <button id="run">Run ▶</button>
  <button id="stop" disabled>Stop ■</button>
  <span id="status">Ready</span>
</header>

<div id="app">
  <section id="left">
    <div class="pane">Editor</div>
    <div id="editorWrap"><textarea id="editor"></textarea></div>
  </section>

  <section id="right">
    <div class="pane">Turtle</div>
    <div id="stageWrap">
      <canvas id="stage"></canvas>
      <canvas id="overlay"></canvas>
    </div>
    <div class="pane">Console</div>
    <div id="consoleWrap"><div id="console"></div></div>
  </section>
</div>

<script type="module">
/* ================== Editor ================== */
const editor = CodeMirror.fromTextArea(document.getElementById("editor"), {
  mode: "python",
  lineNumbers: true,
  indentUnit: 4
});
editor.setValue(
`import turtle

turtle.speed(3)
for _ in range(4):
    turtle.forward(40)
    turtle.left(90)`
);

/* ================== Canvas ================== */
const canvas = document.getElementById("stage");
const ctx = canvas.getContext("2d");
const overlay = document.getElementById("overlay");
const octx = overlay.getContext("2d");

function resizeCanvas() {
  for (const c of [canvas, overlay]) {
    const r = c.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    c.width = r.width * dpr;
    c.height = r.height * dpr;
    c.getContext("2d").setTransform(dpr,0,0,dpr,0,0);
  }
  redrawTurtle();
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

function toXY(x,y){
  const r = canvas.getBoundingClientRect();
  return { cx:r.width/2+x, cy:r.height/2-y };
}

/* ================== Turtle ================== */
const turtle = { x:0, y:0, heading:0, visible:true, color:"#00ff66" };

function redrawTurtle(){
  octx.clearRect(0,0,overlay.width,overlay.height);
  if(!turtle.visible) return;

  const p = toXY(turtle.x, turtle.y);
  const a = turtle.heading * Math.PI / 180;
  const s = 10;

  octx.beginPath();
  octx.moveTo(p.cx + Math.cos(a)*s, p.cy - Math.sin(a)*s);
  octx.lineTo(p.cx + Math.cos(a+2.5)*s, p.cy - Math.sin(a+2.5)*s);
  octx.lineTo(p.cx + Math.cos(a-2.5)*s, p.cy - Math.sin(a-2.5)*s);
  octx.closePath();
  octx.fillStyle = turtle.color;
  octx.fill();
}

/* ================== Animation ================== */
const queue = [];
let animating = false;

function speedParams(s){
  if (s <= 0) return { instant:true };
  return { px: Math.max(1, s), delay: 30 };
}

function drawSeg(x1,y1,x2,y2,color,width){
  const a = toXY(x1,y1), b = toXY(x2,y2);
  ctx.strokeStyle = color;
  ctx.lineWidth = width;
  ctx.beginPath();
  ctx.moveTo(a.cx,a.cy);
  ctx.lineTo(b.cx,b.cy);
  ctx.stroke();
}

function animateLine(cmd, done){
  const sp = speedParams(cmd.speed);
  if (sp.instant) {
    drawSeg(cmd.x1,cmd.y1,cmd.x2,cmd.y2,cmd.color,cmd.width);
    Object.assign(turtle, cmd.end);
    redrawTurtle();
    done();
    return;
  }

  const dx = cmd.x2 - cmd.x1;
  const dy = cmd.y2 - cmd.y1;
  const dist = Math.hypot(dx,dy);
  const step = sp.px / dist;
  let t = 0;
  let lx = cmd.x1, ly = cmd.y1;

  function tick(){
    t = Math.min(1, t + step);
    const x = cmd.x1 + dx * t;
    const y = cmd.y1 + dy * t;

    drawSeg(lx,ly,x,y,cmd.color,cmd.width);
    turtle.x = x;
    turtle.y = y;
    turtle.heading = cmd.end.heading;
    redrawTurtle();

    lx = x; ly = y;
    if (t < 1) setTimeout(tick, sp.delay);
    else { Object.assign(turtle, cmd.end); redrawTurtle(); done(); }
  }
  tick();
}

function runQueue(){
  if (animating || !queue.length) return;
  animating = true;
  const cmd = queue.shift();
  animateLine(cmd, () => {
    animating = false;
    runQueue();
  });
}

/* ================== Worker ================== */
const consoleEl = document.getElementById("console");
const statusEl = document.getElementById("status");
const worker = new Worker("./py_worker.js", { type:"module" });

worker.onmessage = e => {
  const m = e.data;
  if (m.type === "stdout") {
    consoleEl.textContent += m.text + "\n";
  }
  if (m.type === "canvas_cmd") {
    if (m.cmd.type === "line") {
      queue.push({
        ...m.cmd,
        end: {
          x: m.cmd.x2,
          y: m.cmd.y2,
          heading: turtle.heading,
          visible: turtle.visible,
          color: turtle.color
        }
      });
      runQueue();
    }
    if (m.cmd.type === "turtle") {
      Object.assign(turtle, m.cmd);
      redrawTurtle();
    }
  }
};

document.getElementById("run").onclick = () => {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  queue.length = 0;
  turtle.x = turtle.y = turtle.heading = 0;
  turtle.visible = true;
  redrawTurtle();
  consoleEl.textContent = "";
  worker.postMessage({ type:"run", code: editor.getValue() });
};
</script>
</body>
</html>
