<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trinket-like Python Runner</title>

  <!-- CodeMirror 5 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.css">
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/python/python.js"></script>

  <!-- xterm.js -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.5.0/css/xterm.css">
  <script src="https://cdn.jsdelivr.net/npm/xterm@5.5.0/lib/xterm.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.10.0/lib/xterm-addon-fit.js"></script>

  <style>
    body { margin: 0; height: 100vh; display: flex; flex-direction: column; font-family: system-ui, sans-serif; }
    header { display: flex; gap: 10px; align-items: center; padding: 10px 12px; border-bottom: 1px solid #ddd; }
    #status { color: #666; font-size: 14px; }
    .spacer { flex: 1; }
    button { padding: 8px 12px; cursor: pointer; }

    #app { flex: 1; display: flex; min-height: 0; }
    #left, #right { width: 50%; display: flex; flex-direction: column; min-height: 0; }
    #left { border-right: 1px solid #ddd; }
    .pane-title { padding: 8px 12px; font-size: 14px; color: #444; border-bottom: 1px solid #eee; }

    #editorWrap { flex: 1; min-height: 0; }
    .CodeMirror { height: 100% !important; }

    /* terminal pane */
    #terminalWrap { flex: 1; min-height: 0; }
    #terminal { width: 100%; height: 100%; }
  </style>
</head>

<body>
<header>
  <button id="run" disabled>Run ▶</button>
  <button id="clear" disabled>Clear</button>
  <div class="spacer"></div>
  <div id="status">Starting…</div>
</header>

<div id="app">
  <section id="left">
    <div class="pane-title">main.py</div>
    <div id="editorWrap"><textarea id="editor"></textarea></div>
  </section>

  <section id="right">
    <div class="pane-title">Console</div>
    <div id="terminalWrap"><div id="terminal"></div></div>
  </section>
</div>

<script type="module">
  import { loadPyodide } from "https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.mjs";

  const runBtn = document.getElementById("run");
  const clearBtn = document.getElementById("clear");
  const statusEl = document.getElementById("status");

  const setStatus = (s) => statusEl.textContent = s;

  // --- Editor (CodeMirror 5)
  if (!window.CodeMirror) {
    setStatus("Editor failed (CodeMirror not loaded)");
    throw new Error("CodeMirror missing (CDN blocked?)");
  }
  const cm = CodeMirror.fromTextArea(document.getElementById("editor"), {
    mode: "python",
    lineNumbers: true,
    indentUnit: 4,
    tabSize: 4
  });
  cm.setSize(null, "100%");

  async function loadInitialCode() {
    try {
      const res = await fetch("./main.py", { cache: "no-store" });
      if (!res.ok) throw new Error(`Could not load main.py (HTTP ${res.status})`);
      cm.setValue(await res.text());
    } catch (e) {
      cm.setValue(`print("main.py missing")\nname = input("Your name? ")\nprint("Hi", name)\n`);
      term.writeln(String(e));
    }
  }

  // --- Terminal (xterm)
  const term = new Terminal({
    convertEol: true,
    cursorBlink: true,
    fontFamily: 'ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace',
    fontSize: 14
  });
  const fitAddon = new FitAddon.FitAddon();
  term.loadAddon(fitAddon);
  term.open(document.getElementById("terminal"));
  fitAddon.fit();

  window.addEventListener("resize", () => fitAddon.fit());

  function termClear() {
    term.reset();
  }

  clearBtn.onclick = termClear;

  // --- Console-style input IN the terminal (single window)
  let inputActive = false;
  let inputBuffer = "";
  let inputResolver = null;

  function enableTerminalInput(promptText) {
    inputActive = true;
    inputBuffer = "";
    if (promptText) term.write(promptText);
    // now user types on same line
    return new Promise((resolve) => { inputResolver = resolve; });
  }

  function disableTerminalInput() {
    inputActive = false;
    inputBuffer = "";
    inputResolver = null;
  }

  term.onData((data) => {
    if (!inputActive) return;

    // Enter
    if (data === "\r") {
      term.write("\r\n");
      const line = inputBuffer;
      const resolve = inputResolver;
      disableTerminalInput();
      if (resolve) resolve(line);
      return;
    }

    // Backspace (DEL)
    if (data === "\u007F") {
      if (inputBuffer.length > 0) {
        inputBuffer = inputBuffer.slice(0, -1);
        // erase one char visually
        term.write("\b \b");
      }
      return;
    }

    // Ctrl+C
    if (data === "\u0003") {
      term.write("^C\r\n");
      const resolve = inputResolver;
      disableTerminalInput();
      if (resolve) resolve(""); // treat as empty input
      return;
    }

    // Ignore other control chars
    if (data < " " || data === "\u0000") return;

    // Normal text
    inputBuffer += data;
    term.write(data);
  });

  // --- Pyodide
  setStatus("Loading Python…");
  const pyodide = await loadPyodide();

  // stdout/stderr -> terminal
  pyodide.setStdout({ batched: (s) => term.writeln(s) });
  pyodide.setStderr({ batched: (s) => term.writeln(s) });

  // Provide async input() that reads from terminal
  pyodide.globals.set("__term_input__", enableTerminalInput);

  await pyodide.runPythonAsync(`
import builtins

async def _input(prompt=""):
    return await __term_input__(str(prompt))

builtins.input = _input
  `.trim());

  // Wrap user code so plain input() becomes await input()
  function wrapUserCode(src) {
    // IMPORTANT: regex literal with normal escapes
    const transformed = src.replace(/(^|[^\w.])input\s*\(/g, "$1await input(");
    const indented = transformed.split("\n").map(l => "    " + l);
    return ["async def __main__():", ...indented, "", "await __main__()"].join("\n");
  }

  await loadInitialCode();

  setStatus("Ready");
  runBtn.disabled = false;
  clearBtn.disabled = false;

  runBtn.onclick = async () => {
    runBtn.disabled = true;
    setStatus("Running…");

    // make terminal feel fresh per run (optional)
    // termClear();

    try {
      await pyodide.runPythonAsync(wrapUserCode(cm.getValue()));
      setStatus("Done");
    } catch (e) {
      setStatus("Error");
      term.writeln(String(e));
    } finally {
      runBtn.disabled = false;
    }
  };

  // focus terminal when user clicks console pane
  document.getElementById("terminalWrap").addEventListener("mousedown", () => term.focus());
  term.focus();
</script>
</body>
</html>
